name: create release
on:
  workflow_dispatch:
    inputs:
      TAG:
        description: 'Tag name'
        required: true
        type: string
  push:
    tags:
      - 'v*.*.*-rc.*'

jobs:
  once:
    name: Build, Test, Create And Upload Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - uses: actions/checkout@24cb9080177205b6e8c946b17badbe402adc938f
        name: checkout repo content
        with:
          token: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }} #name of the token
        
      - id: tag-calculator
        # uses: ./.github/actions/tag-action
        uses: kubescape/workflows/.github/actions/tag-action@main
        with: 
          ORIGINAL_TAG: ${{ inputs.TAG }}
          SUB_STRING: "-rc"

      # Test using Golang OPA hot rule compilation
      - name: Set up Go
        uses: actions/setup-go@6edd4406fa81c3da01a34fa6f6343087c207a568
        with:
          go-version: 1.19

      - name: Test Regoes
        working-directory: testrunner
        run: |
          apt update && apt install -y cmake
          GOPATH=$(go env GOPATH) make
      - name: setup python
        uses: actions/setup-python@75f3110429a8c05be0e1bf360334e4cced2b63fa
        with:
          python-version: 3.10.6

      - name: Create Metadata Release Files
        run: |
          python ./scripts/export.py

      # The next step kept here for only backward competability.
      # Release files should have extensions!
      - name: Strip Metadata Files Extensions (to be removed)
        run: |
          cd release
          find -type f -name '*.json' | while read f; do mv "$f" "${f%.json}"; done
          find -type f -name '*.csv' | while read f; do mv "$f" "${f%.csv}"; done

      - name: kubescape_e2e_test
        uses: kubescape/kubescape/.github/workflows/b-binary-build-and-e2e-tests.yaml@master
        with:
          COMPONENT_NAME: kubescape
          CGO_ENABLED: 1
          GO111MODULE: ""
          GO_VERSION: "1.19"
          RELEASE: ""
          CLIENT: test
          CHECKOUT_REPO: kubescape/kubescape
          BUILD_AND_TEST_LOCAL_KUBESCAPE_CLI: false

      - name: Create Release and upload assets
        id: create_release_upload_assets
        uses: softprops/action-gh-release@de2c0eb89ae2a093876385947365aca7b0e5f844
        with:
          token: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}
          name: Release ${{ inputs.TAG }}
          tag_name: ${{ inputs.TAG }}
          body: ${{ github.event.pull_request.body }}
          draft: false
          fail_on_unmatched_files: true
          prerelease: false
          files: 'release/*'

      - run: git status

      - run: git diff

      - name: Commit change and push
        uses: stefanzweifel/git-auto-commit-action@v4.16.0
        with:
          branch: main
          commit_message: "Updated..."