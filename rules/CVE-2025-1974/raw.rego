package armo_builtins

# Check Deployments
deny[msga] {
	deployment := input[_]
	deployment.kind == "Deployment"
	container := deployment.spec.template.spec.containers[i]
	is_nginx_ingress_image(container.image)
	is_tag_image(container.image)

	# Check if version is vulnerable
	image_version := extract_version(container.image)
	is_vulnerable_version(image_version)

	# Only vulnerable if validating webhook is enabled
	is_validating_webhook_enabled(container)

	path := sprintf("spec.template.spec.containers[%v].image", [format_int(i, 10)])
	msga := {
		"alertMessage": sprintf("Deployment %v/%v is vulnerable to CVE-2025-1974 (ingress-nginx arbitrary code execution) with validating admission webhook enabled", [deployment.metadata.namespace, deployment.metadata.name]),
		"reviewPaths": [path],
		"failedPaths": [path],
		"fixPaths": [],
		"alertObject": {"k8SApiObjects": [deployment]},
	}
}

# Check DaemonSets
deny[msga] {
	daemonset := input[_]
	daemonset.kind == "DaemonSet"
	container := daemonset.spec.template.spec.containers[i]
	is_nginx_ingress_image(container.image)
	is_tag_image(container.image)

	image_version := extract_version(container.image)
	is_vulnerable_version(image_version)

	# Only vulnerable if validating webhook is enabled
	is_validating_webhook_enabled(container)

	path := sprintf("spec.template.spec.containers[%v].image", [format_int(i, 10)])
	msga := {
		"alertMessage": sprintf("DaemonSet %v/%v is vulnerable to CVE-2025-1974 (ingress-nginx arbitrary code execution) with validating admission webhook enabled", [daemonset.metadata.namespace, daemonset.metadata.name]),
		"reviewPaths": [path],
		"failedPaths": [path],
		"fixPaths": [],
		"alertObject": {"k8SApiObjects": [daemonset]},
	}
}

# Check StatefulSets
deny[msga] {
	statefulset := input[_]
	statefulset.kind == "StatefulSet"
	container := statefulset.spec.template.spec.containers[i]
	is_nginx_ingress_image(container.image)
	is_tag_image(container.image)

	image_version := extract_version(container.image)
	is_vulnerable_version(image_version)

	# Only vulnerable if validating webhook is enabled
	is_validating_webhook_enabled(container)

	path := sprintf("spec.template.spec.containers[%v].image", [format_int(i, 10)])
	msga := {
		"alertMessage": sprintf("StatefulSet %v/%v is vulnerable to CVE-2025-1974 (ingress-nginx arbitrary code execution) with validating admission webhook enabled", [statefulset.metadata.namespace, statefulset.metadata.name]),
		"reviewPaths": [path],
		"failedPaths": [path],
		"fixPaths": [],
		"alertObject": {"k8SApiObjects": [statefulset]},
	}
}

# Helper: Extract version array from image tag
extract_version(image) = image_version {
	tag_version_match := regex.find_all_string_submatch_n(`[0-9]+\.[0-9]+\.[0-9]+`, image, -1)[0][0]
	image_version_str_arr := split(tag_version_match, ".")
	image_version := [to_number(image_version_str_arr[0]), to_number(image_version_str_arr[1]), to_number(image_version_str_arr[2])]
}

# Helper: Check if validating webhook is enabled
# The vulnerability requires the validating admission webhook to be enabled
# Check if either:
# 1. The ingress-nginx-admission ValidatingWebhookConfiguration exists, OR
# 2. The container has the --validating-webhook argument
is_validating_webhook_enabled(container) {
	arg := container.args[_]
	contains(arg, "--validating-webhook")
}

is_validating_webhook_enabled(container) {
	webhook := input[_]
	webhook.kind == "ValidatingWebhookConfiguration"
	contains(webhook.metadata.name, "ingress-nginx-admission")
}

# Helper: Check if image is nginx-ingress
is_nginx_ingress_image(image) {
	contains(image, "ingress-nginx/controller")
}

is_nginx_ingress_image(image) {
	contains(image, "nginx-ingress-controller")
}

is_nginx_ingress_image(image) {
	contains(image, "ingress-controller")
	contains(image, "nginx")
}

# Helper: Check if image has a tag (not using :latest or digest)
is_tag_image(image) {
	reg := ":[\\w][\\w.-]{0,127}(\/)?"
	version := regex.find_all_string_submatch_n(reg, image, -1)
	v := version[_]
	img := v[_]
	not endswith(img, "/")
}

# Affected versions :
# All versions < v1.11.0 (covers v0.x, v1.0.x through v1.10.x)
is_vulnerable_version(image_version) {
	image_version[0] == 0
}

is_vulnerable_version(image_version) {
	image_version[0] == 1
	image_version[1] < 11
}

# v1.11.0 - v1.11.4
is_vulnerable_version(image_version) {
	image_version[0] == 1
	image_version[1] == 11
	image_version[2] <= 4
}

# v1.12.0
is_vulnerable_version(image_version) {
	image_version[0] == 1
	image_version[1] == 12
	image_version[2] == 0
}
