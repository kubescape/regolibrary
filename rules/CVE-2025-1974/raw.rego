package armo_builtins

  # Check Deployments
  deny[msga] {
      deployment := input[_]
      deployment.kind == "Deployment"
      container := deployment.spec.template.spec.containers[i]
      is_nginx_ingress_image(container.image)
      is_tag_image(container.image)

      # Extract version from image tag
      tag_version_match := regex.find_all_string_submatch_n(`[0-9]+\.[0-9]+\.[0-9]+`, container.image, -1)[0][0]
      image_version_str_arr := split(tag_version_match, ".")
      image_version := [to_number(image_version_str_arr[0]), to_number(image_version_str_arr[1]), to_number(image_version_str_arr[2])]

      # Check if version is vulnerable
      is_vulnerable_version(image_version)

      path := sprintf("spec.template.spec.containers[%v].image", [format_int(i, 10)])
      msga := {
          "alertMessage": sprintf("Deployment %v/%v is vulnerable to CVE-2025-1974 (ingress-nginx arbitrary code execution)", [deployment.metadata.namespace, deployment.metadata.name]),
          "reviewPaths": [path],
          "failedPaths": [path],
          "fixPaths": [],
          "alertObject": {"k8SApiObjects": [deployment]},
      }
  }

  # Check DaemonSets
  deny[msga] {
      daemonset := input[_]
      daemonset.kind == "DaemonSet"
      container := daemonset.spec.template.spec.containers[i]
      is_nginx_ingress_image(container.image)
      is_tag_image(container.image)

      tag_version_match := regex.find_all_string_submatch_n(`[0-9]+\.[0-9]+\.[0-9]+`, container.image, -1)[0][0]
      image_version_str_arr := split(tag_version_match, ".")
      image_version := [to_number(image_version_str_arr[0]), to_number(image_version_str_arr[1]), to_number(image_version_str_arr[2])]

      is_vulnerable_version(image_version)

      path := sprintf("spec.template.spec.containers[%v].image", [format_int(i, 10)])
      msga := {
          "alertMessage": sprintf("DaemonSet %v/%v is vulnerable to CVE-2025-1974 (ingress-nginx arbitrary code execution)", [daemonset.metadata.namespace, daemonset.metadata.name]),
          "reviewPaths": [path],
          "failedPaths": [path],
          "fixPaths": [],
          "alertObject": {"k8SApiObjects": [daemonset]},
      }
  }

  # Check StatefulSets
  deny[msga] {
      statefulset := input[_]
      statefulset.kind == "StatefulSet"
      container := statefulset.spec.template.spec.containers[i]
      is_nginx_ingress_image(container.image)
      is_tag_image(container.image)

      tag_version_match := regex.find_all_string_submatch_n(`[0-9]+\.[0-9]+\.[0-9]+`, container.image, -1)[0][0]
      image_version_str_arr := split(tag_version_match, ".")
      image_version := [to_number(image_version_str_arr[0]), to_number(image_version_str_arr[1]), to_number(image_version_str_arr[2])]

      is_vulnerable_version(image_version)

      path := sprintf("spec.template.spec.containers[%v].image", [format_int(i, 10)])
      msga := {
          "alertMessage": sprintf("StatefulSet %v/%v is vulnerable to CVE-2025-1974 (ingress-nginx arbitrary code execution)", [statefulset.metadata.namespace, statefulset.metadata.name]),
          "reviewPaths": [path],
          "failedPaths": [path],
          "fixPaths": [],
          "alertObject": {"k8SApiObjects": [statefulset]},
      }
  }

  # Helper: Check if image is nginx-ingress
  is_nginx_ingress_image(image) {
      contains(image, "ingress-nginx/controller")
  }

  is_nginx_ingress_image(image) {
      contains(image, "nginx-ingress-controller")
  }

  is_nginx_ingress_image(image) {
      contains(image, "ingress-controller")
      contains(image, "nginx")
  }

  # Helper: Check if image has a tag (not using :latest or digest)
  is_tag_image(image) {
      reg := ":[\\w][\\w.-]{0,127}(\/)?"
      version := regex.find_all_string_submatch_n(reg, image, -1)
      v := version[_]
      img := v[_]
      not endswith(img, "/")
  }

  # Affected versions :
  # All versions < v1.11.0 (covers v0.x, v1.0.x through v1.10.x)
  is_vulnerable_version(image_version) {
      image_version[0] == 0
  }

  is_vulnerable_version(image_version) {
      image_version[0] == 1
      image_version[1] < 11
  }

  # v1.11.0 - v1.11.4
  is_vulnerable_version(image_version) {
      image_version[0] == 1
      image_version[1] == 11
      image_version[2] <= 4
  }

  # v1.12.0
  is_vulnerable_version(image_version) {
      image_version[0] == 1
      image_version[1] == 12
      image_version[2] == 0
  }
