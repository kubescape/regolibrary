package armo_builtins

import rego.v1

# Check Deployments
deny contains msga if {
	deployment := input[_]
	deployment.kind == "Deployment"
	container := deployment.spec.template.spec.containers[i]
	is_mongodb_image(container.image)
	is_tag_image(container.image)

	# Check if version is vulnerable
	image_version := extract_version(container.image)
	is_vulnerable_version(image_version)

	path := sprintf("spec.template.spec.containers[%v].image", [format_int(i, 10)])
	msga := {
		"alertMessage": sprintf("Deployment %v/%v is vulnerable to CVE-2025-14847 (MongoDB Zlib memory read vulnerability)", [deployment.metadata.namespace, deployment.metadata.name]),
		"reviewPaths": [path],
		"failedPaths": [path],
		"fixPaths": [],
		"alertObject": {"k8SApiObjects": [deployment]},
	}
}

# Check DaemonSets
deny contains msga if {
	daemonset := input[_]
	daemonset.kind == "DaemonSet"
	container := daemonset.spec.template.spec.containers[i]
	is_mongodb_image(container.image)
	is_tag_image(container.image)

	image_version := extract_version(container.image)
	is_vulnerable_version(image_version)

	path := sprintf("spec.template.spec.containers[%v].image", [format_int(i, 10)])
	msga := {
		"alertMessage": sprintf("DaemonSet %v/%v is vulnerable to CVE-2025-14847 (MongoDB Zlib memory read vulnerability)", [daemonset.metadata.namespace, daemonset.metadata.name]),
		"reviewPaths": [path],
		"failedPaths": [path],
		"fixPaths": [],
		"alertObject": {"k8SApiObjects": [daemonset]},
	}
}

# Check StatefulSets
deny contains msga if {
	statefulset := input[_]
	statefulset.kind == "StatefulSet"
	container := statefulset.spec.template.spec.containers[i]
	is_mongodb_image(container.image)
	is_tag_image(container.image)

	image_version := extract_version(container.image)
	is_vulnerable_version(image_version)

	path := sprintf("spec.template.spec.containers[%v].image", [format_int(i, 10)])
	msga := {
		"alertMessage": sprintf("StatefulSet %v/%v is vulnerable to CVE-2025-14847 (MongoDB Zlib memory read vulnerability)", [statefulset.metadata.namespace, statefulset.metadata.name]),
		"reviewPaths": [path],
		"failedPaths": [path],
		"fixPaths": [],
		"alertObject": {"k8SApiObjects": [statefulset]},
	}
}

# Helper: Extract version array from image tag
extract_version(image) := image_version if {
	matches := regex.find_all_string_submatch_n(`[0-9]+\.[0-9]+\.[0-9]+`, image, -1)
	count(matches) > 0
	tag_version_match := matches[0][0]
	image_version_str_arr := split(tag_version_match, ".")
	image_version := [to_number(image_version_str_arr[0]), to_number(image_version_str_arr[1]), to_number(image_version_str_arr[2])]
}

# Helper: Check if image is MongoDB
# Matches official mongo images: mongo:tag or registry.io/mongo:tag
is_mongodb_image(image) if {
	regex.match(`(^|/)mongo:`, image)
}

# Also match digest-based references: mongo@sha256:...
is_mongodb_image(image) if {
	regex.match(`(^|/)mongo@`, image)
}

# Match Bitnami MongoDB images
is_mongodb_image(image) if {
	regex.match(`bitnami/mongodb:`, image)
}

# Match Bitnami MongoDB digest references
is_mongodb_image(image) if {
	regex.match(`bitnami/mongodb@`, image)
}

# Match Bitnami Legacy MongoDB images
is_mongodb_image(image) if {
	regex.match(`bitnamilegacy/mongodb:`, image)
}

# Match Bitnami Legacy MongoDB digest references
is_mongodb_image(image) if {
	regex.match(`bitnamilegacy/mongodb@`, image)
}

# Helper: Check if image has a tag (not using :latest or digest)
is_tag_image(image) if {
	reg := ":[\\w][\\w.-]{0,127}(\/)?"
	version := regex.find_all_string_submatch_n(reg, image, -1)
	v := version[_]
	img := v[_]
	not endswith(img, "/")
}

# Affected versions:
# - All v3.6.x versions (>= 3.6.0)
is_vulnerable_version(image_version) if {
	image_version[0] == 3
	image_version[1] == 6
}

# - All v4.0.x versions (>= 4.0.0)
is_vulnerable_version(image_version) if {
	image_version[0] == 4
	image_version[1] == 0
}

# - All v4.2.x versions (>= 4.2.0)
is_vulnerable_version(image_version) if {
	image_version[0] == 4
	image_version[1] == 2
}

# - v4.4 versions prior to 4.4.30
is_vulnerable_version(image_version) if {
	image_version[0] == 4
	image_version[1] == 4
	image_version[2] < 30
}

# - v5.0 versions prior to 5.0.32
is_vulnerable_version(image_version) if {
	image_version[0] == 5
	image_version[1] == 0
	image_version[2] < 32
}

# - v6.0 versions prior to 6.0.27
is_vulnerable_version(image_version) if {
	image_version[0] == 6
	image_version[1] == 0
	image_version[2] < 27
}

# - v7.0 versions prior to 7.0.28
is_vulnerable_version(image_version) if {
	image_version[0] == 7
	image_version[1] == 0
	image_version[2] < 28
}

# - v8.0 versions prior to 8.0.17
is_vulnerable_version(image_version) if {
	image_version[0] == 8
	image_version[1] == 0
	image_version[2] < 17
}

# - v8.2 versions prior to 8.2.3
is_vulnerable_version(image_version) if {
	image_version[0] == 8
	image_version[1] == 2
	image_version[2] < 3
}
