package armo_builtins

deny[msga] {
	node := input[_]
    node.kind == "Node"
    kernel_version_match := regex.find_all_string_submatch_n("[0-9]+\\.[0-9]+\\.[0-9]+", node.status.nodeInfo.kernelVersion, -1)
    kernelVersion := kernel_version_match[0][0]
    
    kernel_version_arr := split(kernelVersion, ".")
    to_number(kernel_version_arr[0]) == 5
    to_number(kernel_version_arr[1]) >= 1
    to_number(kernel_version_arr[1]) <= 16
    to_number(kernel_version_arr[2]) < 2 
    
    node.status.nodeInfo.operatingSystem == "linux"
    path := "status.nodeInfo.kernelVersion"

   linux_kernel_vars := [linux_kernel_var | linux_kernel_var = input[_]; linux_kernel_var.kind == "LinuxKernelVariables"]
   linux_kernel_vars_for_node := [linux_kernel_var | linux_kernel_var = linux_kernel_vars[_]; linux_kernel_var.metadata.name == node.metadata.name]
   data_userns_clones := [linux_kernel_var | linux_kernel_var = linux_kernel_vars_for_node[_].data[_]; is_unprivileged_userns_clone_enabled(linux_kernel_var)]
   count(data_userns_clones) > 0

   external_vector := {
       "name": node.metadata.name,
		"namespace": "",
		"kind": node.kind,
		"relatedObjects": linux_kernel_vars_for_node,
        "kernelVersion": node.status.nodeInfo.kernelVersion
   }


 	msga := {
			"alertMessage": "You are vulnerable to CVE-2022-0185",
    		"alertObject": {
                "externalObjects": external_vector
            },
            "reviewPaths": ["kernelVersion"],
			"failedPaths": ["kernelVersion"],
            "fixPaths":[],
	}
}

is_unprivileged_userns_clone_enabled(linux_kernel_var) {
	linux_kernel_var.key == "unprivileged_userns_clone"
    linux_kernel_var.value == "1\n"
}