package armo_builtins

import rego.v1

deny contains msga if {
	nodes := input[_]
	current_version := nodes.status.nodeInfo.kubeletVersion
	isVulnerableVersion(current_version)
	versionPath = "status.nodeInfo.kubeletVersion"
	pod := input[_]
	pod.kind == "Pod"

	msga := {
		"alertMessage": "",
		"alertObject": {"k8SApiObjects": [pod]},
		"failedPaths": [],
	}
}

deny contains msga if {
	nodes := input[_]
	current_version := nodes.status.nodeInfo.kubeletVersion
	isVulnerableVersion(current_version)
	versionPath = "status.nodeInfo.kubeletVersion"
	wl := input[_]
	spec_template_spec_patterns := {"Deployment", "ReplicaSet", "DaemonSet", "StatefulSet", "Job"}
	spec_template_spec_patterns[wl.kind]

	msga := {
		"alertMessage": "",
		"alertObject": {"k8SApiObjects": [wl]},
		"failedPaths": [],
	}
}

deny contains msga if {
	nodes := input[_]
	current_version := nodes.status.nodeInfo.kubeletVersion
	isVulnerableVersion(current_version)
	versionPath = "status.nodeInfo.kubeletVersion"
	wl := input[_]
	wl.kind == "CronJob"

	msga := {
		"alertMessage": "",
		"alertObject": {"k8SApiObjects": [wl]},
		"failedPaths": [],
	}
}

isVulnerableVersion(version) if {
	version <= "v1.19.14"
}

isVulnerableVersion(version) if {
	version >= "v1.22.0"
	version <= "v1.22.1"
}

isVulnerableVersion(version) if {
	version >= "v1.21.0"
	version <= "v1.21.4"
}

isVulnerableVersion(version) if {
	version >= "v1.20.0"
	version <= "v1.20.9"
}

isVulnerableVersion(version) if {
	version == "v1.20.10"
}
