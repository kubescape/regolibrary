package armo_builtins


deny[msga] {
	nodes := input[_]
	current_version := nodes.status.nodeInfo.kubeletVersion
    is_vulnerable_version(current_version)
    pod := input[_]
    pod.kind == "Pod"
	container := pod.spec.containers[i]
	start_of_path := "spec."
    final_path := is_sub_path_container(container, i, start_of_path)

	msga := {
			"alertMessage": sprintf("You may be vulnerable to CVE-2021-25741. You have a Node with a vulnerable version and the following container : %v in pod : %v with subPath/subPathExpr", [container.name, pod.metadata.name]),
			"alertObject": {"k8SApiObjects": [pod]},
			"deletePaths": final_path,
			"failedPaths": final_path,
			"fixPaths": [],
		}
}


deny[msga] {
	nodes := input[_]
	current_version := nodes.status.nodeInfo.kubeletVersion
    is_vulnerable_version(current_version)
    wl := input[_]
	spec_template_spec_patterns := {"Deployment","ReplicaSet","DaemonSet","StatefulSet","Job"}
	spec_template_spec_patterns[wl.kind]
    container := wl.spec.template.spec.containers[i]
	start_of_path := "spec.template.spec."
    final_path := is_sub_path_container(container, i, start_of_path)
       
	msga := {
	"alertMessage": sprintf("You may be vulnerable to CVE-2021-25741. You have a Node with a vulnerable version and the following container : %v in %v : %v with subPath/subPathExpr", [container.name, wl.kind, wl.metadata.name]),
			"alertObject": {"k8SApiObjects": [wl]},
			"deletePaths": final_path,
			"failedPaths": final_path,
			"fixPaths": [],
		}
}



deny[msga] {
	nodes := input[_]
	current_version := nodes.status.nodeInfo.kubeletVersion
    is_vulnerable_version(current_version)
    wl := input[_]
	wl.kind == "CronJob"
	container = wl.spec.jobTemplate.spec.template.spec.containers[i]
	start_of_path := "spec.jobTemplate.spec.template.spec."
    final_path := is_sub_path_container(container, i, start_of_path)
    
	msga := {
		"alertMessage": sprintf("You may be vulnerable to CVE-2021-25741. You have a Node with a vulnerable version and the following container : %v in %v : %v with subPath/subPathExpr", [container.name, wl.kind, wl.metadata.name]),
			"alertObject": {"k8SApiObjects": [wl]},
			"deletePaths": final_path,
			"failedPaths": final_path,
			"fixPaths": [],
		}
}



is_sub_path_container(container, i, start_of_path) = path {
	path = [sprintf("%vcontainers[%v].volumeMounts[%v].subPath" ,[start_of_path, format_int(i, 10), format_int(j, 10)]) | volume_mount = container.volumeMounts[j];  volume_mount.subPath]
	count(path) > 0
}

is_vulnerable_version(version)  {
    version <=  "v1.19.14"
}

is_vulnerable_version(version){
    version >= "v1.22.0"
    version <= "v1.22.1"
}


is_vulnerable_version(version){
    version >= "v1.21.0"
    version <= "v1.21.4"
}


is_vulnerable_version(version){
    version >= "v1.20.0"
    version <= "v1.20.9"
}

is_vulnerable_version(version){
	version == "v1.20.10"
}


