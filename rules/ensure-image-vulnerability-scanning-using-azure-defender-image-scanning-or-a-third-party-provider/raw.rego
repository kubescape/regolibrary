package armo_builtins

# fails in case Azure Defender image scanning is not enabled.
deny[msga] {
    cluster_describe := input[_]
	cluster_describe.apiVersion == "management.azure.com/v1"
	cluster_describe.kind == "ClusterDescribe"
	cluster_describe.metadata.provider == "aks"
	properties := cluster_describe.data.properties 

    not isAzureImageScanningEnabled(properties)

    msga := {
		"alertMessage": "Azure Defender image scanning is not enabled.",
		"alertScore": 2,
		"failedPaths": [],
		"fixPaths": [],
		"fixCommand": "az aks update --enable-defender --resource-group <your-resource-group> --name <your-cluster-name>",
		"packagename": "armo_builtins",
		"alertObject": {
            "externalObjects": cluster_describe
        },

	}
}

# isAzureImageScanningEnabled check if Azure Defender is enabled into the ClusterDescribe object.
isAzureImageScanningEnabled(properties) {
    properties.securityProfile.defender.securityMonitoring.enabled == true
}
